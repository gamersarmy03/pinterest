<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Viddit</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://cdn.jsdelivr.net/npm/appwrite@13.0.1"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background: #000000;
            color: #e5e7eb;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1f2937;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: #8b5cf6;
            border-radius: 4px;
            transition: background 0.2s ease;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a78bfa;
        }

        * {
            scrollbar-width: thin;
            scrollbar-color: #8b5cf6 #1f2937;
        }

        .header {
            position: sticky;
            top: 0;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(8px);
            padding: 0.75rem 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 1000;
            border-bottom: 1px solid #1f2937;
            flex-wrap: nowrap;
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 700;
            color: #8b5cf6;
            margin: 0;
            flex-shrink: 0;
        }

        .search-bar input {
            background: #1f2937;
            border: 1px solid #4b5563;
            color: #e5e7eb;
            padding: 0.4rem 0.8rem;
            border-radius: 9999px;
            width: 100%;
            max-width: 200px;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            flex-shrink: 1;
        }

        .search-bar input:focus {
            outline: none;
            border-color: #8b5cf6;
            box-shadow: 0 0 8px rgba(139, 92, 246, 0.3);
        }

        .header-buttons {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-shrink: 0;
        }

        .header-buttons button, .header-buttons img {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .header-buttons button:hover, .header-buttons img:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        .upload-btn {
            background: #8b5cf6;
            color: #ffffff;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            font-weight: 500;
            border: none;
            cursor: pointer;
            line-height: 1;
        }

        .logout-btn {
            background: #ef4444;
            padding: 0.4rem 1rem;
            border-radius: 9999px;
            font-weight: 500;
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 1001;
            color: #ffffff;
            font-size: 0.9rem;
        }

        .video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 1rem;
            padding: 1.5rem;
            max-width: 1400px;
            margin: 0 auto;
        }

        .video-card {
            background: #1f2937;
            border-radius: 0.75rem;
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
            border: 1px solid #4b5563;
            display: flex;
            flex-direction: column;
        }

        .video-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
        }

        .thumbnail-container {
            position: relative;
            width: 100%;
            height: 140px;
            background: #000;
        }

        .thumbnail-container img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-bottom: 2px solid #8b5cf6;
        }

        .title-section {
            padding: 0.5rem;
            border-top: 2px solid #8b5cf6;
            flex-grow: 1;
            position: relative;
        }

        .title-section.golden-border {
            border-top: none;
            box-shadow: 0 0 10px 2px #FFD700, 0 0 20px 5px rgba(255, 215, 0, 0.5);
            background: linear-gradient(to top, transparent, transparent 1px, #1f2937 1px);
        }

        .video-card h3 {
            margin: 0;
            font-size: 0.95rem;
            font-weight: 500;
            color: #e5e7eb;
        }

        .upload-form {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #1f2937;
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            width: 90%;
            max-width: 450px;
            animation: slideIn 0.3s ease;
            border: 1px solid #4b5563;
        }

        .upload-form input {
            background: #374151;
            border: 1px solid #4b5563;
            color: #e5e7eb;
            padding: 0.6rem;
            border-radius: 0.5rem;
            margin-bottom: 0.75rem;
            width: 100%;
            font-size: 0.9rem;
        }

        .upload-form button {
            background: #8b5cf6;
            padding: 0.6rem;
            border-radius: 0.5rem;
            font-weight: 500;
            margin-right: 0.5rem;
            color: #ffffff;
            font-size: 0.9rem;
        }

        .upload-form button.cancel-btn {
            background: #ef4444;
        }

        .upload-status {
            margin-top: 0.75rem;
            text-align: center;
            color: #9ca3af;
            font-size: 0.9rem;
        }

        .video-popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #0d1117;
            padding: 1rem;
            border-radius: 0.75rem;
            z-index: 1000;
            width: 90%;
            max-width: 800px;
            animation: slideIn 0.3s ease;
            border: none;
        }

        .video-container {
            position: relative;
            width: 100%;
            padding-bottom: 56.25%;
            background: #000;
        }

        .video-container video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 0.5rem;
        }

        .video-popup:fullscreen {
            top: 0;
            left: 0;
            transform: none;
            width: 100%;
            height: 100%;
            padding: 0;
            border-radius: 0;
            background: #000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .video-popup:fullscreen .video-container {
            padding-bottom: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .video-popup:fullscreen .video-container video {
            width: 100%;
            height: 100%;
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .video-popup:-webkit-full-screen {
            top: 0;
            left: 0;
            transform: none;
            width: 100%;
            height: 100%;
            padding: 0;
            border-radius: 0;
            background: #000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .video-popup:-webkit-full-screen .video-container {
            padding-bottom: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .video-popup:-webkit-full-screen .video-container video {
            width: 100%;
            height: 100%;
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .video-popup:-moz-full-screen {
            top: 0;
            left: 0;
            transform: none;
            width: 100%;
            height: 100%;
            padding: 0;
            border-radius: 0;
            background: #000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .video-popup:-moz-full-screen .video-container {
            padding-bottom: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .video-popup:-moz-full-screen .video-container video {
            width: 100%;
            height: 100%;
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .video-controls {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(13, 17, 23, 0.9), transparent);
            padding: 0.5rem 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            opacity: 1;
            transition: opacity 0.3s ease-in-out;
            gap: 0.75rem;
        }

        .video-popup:fullscreen .video-controls,
        .video-popup:-webkit-full-screen .video-controls,
        .video-popup:-moz-full-screen .video-controls {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 1rem;
            background: linear-gradient(to top, rgba(13, 17, 23, 0.9), transparent);
            opacity: 0;
        }

        .video-popup:fullscreen .video-controls.show,
        .video-popup:-webkit-full-screen .video-controls.show,
        .video-popup:-moz-full-screen .video-controls.show {
            opacity: 1;
        }

        .video-container:hover .video-controls,
        .video-container:focus-within .video-controls {
            opacity: 1;
        }

        .control-button {
            background: #1f2937;
            border: none;
            color: #d1d5db;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            transition: all 0.3s ease;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 3px 3px 6px rgba(0, 0, 0, 0.3), -3px -3px 6px rgba(55, 65, 81, 0.1);
        }

        .control-button:hover,
        .control-button:focus {
            background: #374151;
            color: #ffffff;
            box-shadow: inset 2px 2px 4px rgba(0, 0, 0, 0.3), inset -2px -2px 4px rgba(55, 65, 81, 0.1);
            transform: scale(1.05);
        }

        .progress-container {
            flex-grow: 1;
            display: flex;
            align-items: center;
            position: relative;
        }

        .progress-bar {
            width: 100%;
            height: 5px;
            background: #2d3748;
            border-radius: 5px;
            cursor: pointer;
            position: relative;
            transition: background 0.3s ease;
        }

        .progress-bar:hover {
            background: #4b5563;
        }

        .progress {
            height: 100%;
            background: linear-gradient(90deg, #6366f1, #a855f7);
            border-radius: 5px;
            width: 0;
            position: relative;
            transition: width 0.1s linear;
        }

        .progress::after {
            content: '';
            position: absolute;
            right: -6px;
            top: 50%;
            transform: translateY(-50%);
            width: 12px;
            height: 12px;
            background: #a855f7;
            border-radius: 50%;
            box-shadow: 0 0 8px rgba(168, 85, 247, 0.5);
            display: none;
        }

        .progress-bar:hover .progress::after {
            display: block;
        }

        .timestamp {
            color: #d1d5db;
            font-size: 0.9rem;
            margin-left: 0.75rem;
            min-width: 100px;
            font-weight: 500;
        }

        .playback-speed-container {
            position: relative;
        }

        .playback-speed-btn {
            background: #1f2937;
            border: none;
            color: #d1d5db;
            font-size: 0.9rem;
            padding: 0.4rem 0.6rem;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3), -2px -2px 4px rgba(55, 65, 81, 0.1);
            width: 50px;
            text-align: center;
        }

        .playback-speed-btn:hover,
        .playback-speed-btn:focus {
            background: #374151;
            color: #ffffff;
            box-shadow: inset 2px 2px 4px rgba(0, 0, 0, 0.3), inset -2px -2px 4px rgba(55, 65, 81, 0.1);
        }

        .playback-speed-menu {
            display: none;
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #1f2937;
            border-radius: 6px;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.3);
            z-index: 10;
            width: 50px;
            margin-bottom: 0.5rem;
        }

        .playback-speed-menu.show {
            display: block;
        }

        .playback-speed-option {
            padding: 0.4rem;
            color: #d1d5db;
            font-size: 0.9rem;
            text-align: center;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .playback-speed-option:hover {
            background: #374151;
        }

        .volume-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .volume-slider {
            width: 80px;
            -webkit-appearance: none;
            appearance: none;
            height: 5px;
            background: #2d3748;
            border-radius: 5px;
            outline: none;
            transition: background 0.3s ease;
            position: relative;
            cursor: pointer;
        }

        .volume-slider:hover {
            background: #4b5563;
        }

        .volume-slider::-webkit-slider-runnable-track {
            height: 5px;
            background: #2d3748;
            border-radius: 5px;
        }

        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 12px;
            height: 12px;
            background: #a855f7;
            border-radius: 50%;
            cursor: pointer;
            margin-top: -3.5px;
            box-shadow: 0 0 8px rgba(168, 85, 247, 0.5);
        }

        .volume-slider::-moz-range-track {
            height: 5px;
            background: #2d3748;
            border-radius: 5px;
        }

        .volume-slider::-moz-range-thumb {
            width: 12px;
            height: 12px;
            background: #a855f7;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 8px rgba(168, 85, 247, 0.5);
            border: none;
        }

        .volume-slider::-webkit-slider-runnable-track {
            background: linear-gradient(to right, #6366f1 calc(var(--value) * 100%), #2d3748 calc(var(--value) * 100%));
        }

        .volume-slider::-moz-range-progress {
            background: linear-gradient(to right, #6366f1, #a855f7);
            height: 5px;
            border-radius: 5px;
        }

        .video-popup h3 {
            margin-top: 0.75rem;
            font-size: 1.1rem;
            font-weight: 600;
            color: #e5e7eb;
            text-align: center;
        }

        .video-popup:fullscreen h3,
        .video-popup:-webkit-full-screen h3,
        .video-popup:-moz-full-screen h3 {
            position: absolute;
            top: 1rem;
            left: 50%;
            transform: translateX(-50%);
            margin: 0;
            z-index: 10;
        }

        .profile-popup {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000000;
            padding: 1.5rem;
            z-index: 1000;
            overflow-y: auto;
            overflow-x: hidden;
            animation: fadeIn 0.3s ease;
            border-top: 1px solid #1f2937;
        }

        .profile-info {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .profile-info img {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 3px solid #8b5cf6;
            margin-bottom: 0.75rem;
        }

        .profile-info h2 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #e5e7eb;
        }

        .profile-info p {
            color: #9ca3af;
            font-size: 0.9rem;
        }

        .profile-videos {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 1rem;
            padding: 1rem;
            max-width: 1400px;
            margin: 0 auto;
            overflow: hidden;
        }

        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 999;
        }

        .loading-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #e5e7eb;
            font-size: 1rem;
            background: rgba(0, 0, 0, 0.7);
            padding: 1rem;
            border-radius: 0.5rem;
        }

        .video-error {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #e5e7eb;
            font-size: 1rem;
            text-align: center;
            background: rgba(31, 41, 55, 0.9);
            padding: 1rem;
            border-radius: 0.5rem;
            border: 1px solid #ef4444;
            max-width: 80%;
            z-index: 5;
        }

        .spinner {
            display: inline-block;
            width: 1.2rem;
            height: 1.2rem;
            border: 2px solid #4b5563;
            border-top: 2px solid #8b5cf6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 0.5rem;
            vertical-align: middle;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes slideIn {
            from { transform: translate(-50%, -60%); opacity: 0; }
            to { transform: translate(-50%, -50%); opacity: 1; }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @media (max-width: 768px) {
            .header {
                padding: 0.5rem;
                gap: 0.5rem;
                flex-wrap: nowrap;
            }

            .header h1 {
                font-size: 1.2rem;
            }

            .search-bar input {
                max-width: 120px;
                padding: 0.3rem 0.5rem;
                font-size: 0.8rem;
            }

            .upload-btn {
                width: 28px;
                height: 28px;
                font-size: 1rem;
            }

            .g_id_signin {
                transform: scale(0.8);
            }

            .profile-pic {
                width: 28px !important;
                height: 28px !important;
            }

            .video-grid, .profile-videos {
                grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
                padding: 1rem;
            }

            .video-popup {
                top: 0;
                left: 0;
                transform: none;
                width: 100%;
                height: 100%;
                padding: 0;
                border-radius: 0;
            }

            .video-container {
                padding-bottom: 56.25%;
            }

            .profile-info img {
                width: 80px;
                height: 80px;
            }

            .profile-info h2 {
                font-size: 1.3rem;
            }

            .video-controls {
                padding: 0.5rem;
                gap: 0.5rem;
            }

            .control-button {
                width: 36px;
                height: 36px;
                font-size: 1.1rem;
            }

            .timestamp {
                font-size: 0.8rem;
                min-width: 80px;
            }

            .playback-speed-btn {
                font-size: 0.8rem;
                padding: 0.3rem 0.5rem;
                width: 45px;
            }

            .playback-speed-menu {
                width: 45px;
            }

            .playback-speed-option {
                font-size: 0.8rem;
                padding: 0.3rem;
            }

            .volume-slider {
                width: 60px;
            }
        }

        @media (max-width: 480px) {
            .header {
                padding: 0.4rem;
            }

            .search-bar input {
                max-width: 100px;
            }

            .upload-btn {
                width: 24px;
                height: 24px;
                font-size: 0.9rem;
            }

            .video-grid, .profile-videos {
                grid-template-columns: 1fr;
            }

            .video-container {
                padding-bottom: 56.25%;
            }

            .upload-form {
                padding: 1rem;
            }

            .video-controls {
                flex-wrap: wrap;
                padding: 0.3rem;
                gap: 0.4rem;
            }

            .progress-container {
                margin: 0.5rem 0;
            }

            .volume-slider {
                width: 50px;
            }

            .timestamp {
                font-size: 0.75rem;
                min-width: 70px;
            }

            .playback-speed-btn {
                font-size: 0.75rem;
                width: 40px;
            }

            .playback-speed-menu {
                width: 40px;
            }

            .playback-speed-option {
                font-size: 0.75rem;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Viddit</h1>
        <div class="search-bar">
            <input type="text" id="searchInput" placeholder="Search videos...">
        </div>
        <div class="header-buttons flex items-center space-x-2">
            <button class="upload-btn" id="uploadBtn" onclick="checkLoginAndShowUpload()" style="display: none;">+</button>
            <div id="g_id_onload"
                 data-client_id="1074551886895-70e3csmiqkgiu8jf5e3oc87hbjj78929.apps.googleusercontent.com"
                 data-callback="handleCredentialResponse"
                 data-auto_prompt="false">
            </div>
            <div class="g_id_signin" data-type="standard" data-size="small" data-theme="filled_black" data-text="sign_in_with" data-shape="circle"></div>
            <img id="profilePic" class="profile-pic w-8 h-8 rounded-full cursor-pointer" src="defaultdp.png" alt="Profile" style="display: none;" onclick="openProfilePopup()">
        </div>
    </div>

    <div class="overlay" id="overlay"></div>

    <div class="upload-form" id="uploadForm">
        <h2 class="text-lg font-semibold mb-3">Upload Video</h2>
        <input type="file" id="mediaInput" accept="video/mp4" required>
        <input type="text" id="mediaTitle" placeholder="Enter video title" required>
        <div class="flex justify-end space-x-2">
            <button id="uploadButton" onclick="uploadMedia()">Upload</button>
            <button class="cancel-btn" onclick="hideUploadForm()">Cancel</button>
        </div>
        <div class="upload-status" id="uploadStatus"></div>
    </div>

    <div class="video-popup" id="mediaPopup">
        <div class="video-container">
            <div class="loading-indicator" id="videoLoading">
                <span class="spinner"></span>Loading video...
            </div>
            <div class="video-error" id="videoError" style="display: none;">
                Failed to load video. Check console for details or try again later.
            </div>
            <video id="popupVideo" autoplay="false"></video>
            <div class="video-controls" id="videoControls">
                <button class="control-button" id="playPauseBtn" title="Play/Pause">â–¶</button>
                <div class="progress-container">
                    <div class="progress-bar" id="progressBar">
                        <div class="progress" id="progress"></div>
                    </div>
                    <span class="timestamp" id="timestamp">0:00 / 0:00</span>
                </div>
                <div class="playback-speed-container">
                    <button class="playback-speed-btn" id="playbackSpeedBtn" title="Playback Speed">1x</button>
                    <div class="playback-speed-menu" id="playbackSpeedMenu">
                        <div class="playback-speed-option" data-value="0.5">0.5x</div>
                        <div class="playback-speed-option" data-value="1">1x</div>
                        <div class="playback-speed-option" data-value="1.5">1.5x</div>
                        <div class="playback-speed-option" data-value="2">2x</div>
                    </div>
                </div>
                <div class="volume-container">
                    <button class="control-button" id="volumeBtn" title="Mute/Unmute">ðŸ”Š</button>
                    <input type="range" class="volume-slider" id="volumeSlider" min="0" max="1" step="0.1" value="1">
                </div>
                <button class="control-button" id="fullscreenBtn" title="Fullscreen">â›¶</button>
            </div>
        </div>
        <h3 id="popupTitle" class="text-center"></h3>
    </div>

    <div class="profile-popup" id="profilePopup">
        <button class="logout-btn" onclick="logout()">Logout</button>
        <div class="profile-info" id="profileInfo"></div>
        <div class="profile-videos" id="profileVideos"></div>
    </div>

    <div class="video-grid" id="mediaGrid"></div>

    <script>
        // Initialize Appwrite client
        const client = new Appwrite.Client();
        try {
            client
                .setEndpoint('https://cloud.appwrite.io/v1')
                .setProject('680c91140011c9f522d2');
        } catch (error) {
            console.error('Error initializing Appwrite client:', error);
            alert('Failed to connect to the server. Please try again later.');
        }

        const database = new Appwrite.Databases(client);
        const storage = new Appwrite.Storage(client);

        const DATABASE_ID = '680c91be002fd0778c70';
        const VIDEO_COLLECTION_ID = '680c91d40032b50ad10b';
        const STORAGE_BUCKET_ID = '68106a79003715c715d8';

        // Google Sign-In callback
        function handleCredentialResponse(response) {
            console.log("Google Sign-In response received:", response);
            try {
                if (!response.credential) {
                    throw new Error('No credential provided in Google Sign-In response');
                }
                const base64Url = response.credential.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const data = JSON.parse(atob(base64));
                console.log("Parsed Google Sign-In data:", data);

                if (!data.email || !data.name) {
                    throw new Error('Invalid user data in Google Sign-In response');
                }

                const user = {
                    email: data.email,
                    name: data.name,
                    picture: data.picture || 'defaultdp.png'
                };
                localStorage.setItem('user', JSON.stringify(user));
                updateHeader();
                displayMedia();
            } catch (error) {
                console.error('Error processing Google Sign-In:', error);
                localStorage.removeItem('user');
                updateHeader();
                displayMedia();
                alert('Failed to sign in with Google. Please try again.');
            }
        }

        // Update header based on login state
        function updateHeader() {
            console.log("Updating header...");
            const user = JSON.parse(localStorage.getItem('user'));
            const signInButton = document.querySelector('.g_id_signin');
            const profilePic = document.getElementById('profilePic');
            const uploadBtn = document.getElementById('uploadBtn');

            if (user && user.email && user.name) {
                console.log("User is logged in:", user.email);
                signInButton.style.display = 'none';
                profilePic.src = user.picture;
                profilePic.style.display = 'block';
                uploadBtn.style.display = 'inline-block';
            } else {
                console.log("No valid user logged in");
                signInButton.style.display = 'block';
                profilePic.style.display = 'none';
                uploadBtn.style.display = 'none';
            }
        }

        // Logout function
        function logout() {
            console.log("Logging out...");
            localStorage.removeItem('user');
            updateHeader();
            closeProfilePopup();
            displayMedia();
            history.replaceState(null, '', '/#home');
        }

        // Check login before showing upload form
        function checkLoginAndShowUpload() {
            const user = JSON.parse(localStorage.getItem('user'));
            if (!user) {
                alert('Please log in to upload videos.');
                return;
            }
            showUploadForm();
        }

        function showUploadForm() {
            console.log("Showing upload form...");
            document.getElementById('uploadForm').style.display = 'block';
            document.getElementById('overlay').style.display = 'block';
            document.getElementById('uploadStatus').textContent = '';
        }

        function hideUploadForm() {
            console.log("Hiding upload form...");
            document.getElementById('uploadForm').style.display = 'none';
            document.getElementById('overlay').style.display = 'none';
            document.getElementById('mediaInput').value = '';
            document.getElementById('mediaTitle').value = '';
            document.getElementById('uploadStatus').textContent = '';
            document.getElementById('uploadButton').disabled = false;
            document.getElementById('mediaInput').disabled = false;
            document.getElementById('mediaTitle').disabled = false;
        }

        // Function to capture the first frame of the video as a thumbnail
        async function captureThumbnail(videoFile) {
            return new Promise((resolve, reject) => {
                console.log("Capturing thumbnail...");
                const videoElement = document.createElement('video');
                videoElement.src = URL.createObjectURL(videoFile);
                videoElement.muted = true;
                videoElement.preload = 'metadata';

                videoElement.onloadedmetadata = () => {
                    videoElement.currentTime = 0;
                };

                videoElement.onseeked = () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = videoElement.videoWidth;
                    canvas.height = videoElement.videoHeight;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(videoElement, 0, 0, canvas.width, canvas.height);

                    canvas.toBlob(blob => {
                        if (blob) {
                            const thumbnailFile = new File([blob], 'thumbnail.jpg', { type: 'image/jpeg' });
                            resolve(thumbnailFile);
                        } else {
                            reject(new Error('Failed to generate thumbnail blob'));
                        }
                        URL.revokeObjectURL(videoElement.src);
                    }, 'image/jpeg', 0.9);
                };

                videoElement.onerror = () => {
                    reject(new Error('Failed to load video for thumbnail'));
                    URL.revokeObjectURL(videoElement.src);
                };

                videoElement.load();
            });
        }

        // Function to upload thumbnail to Appwrite Storage
        async function uploadThumbnailToStorage(thumbnailFile) {
            try {
                console.log("Uploading thumbnail...");
                const response = await storage.createFile(
                    STORAGE_BUCKET_ID,
                    'unique()',
                    thumbnailFile
                );
                const thumbnailUrl = `https://cloud.appwrite.io/v1/storage/buckets/${STORAGE_BUCKET_ID}/files/${response.$id}/view?project=680c91140011c9f522d2`;
                return thumbnailUrl;
            } catch (error) {
                console.error('Error uploading thumbnail:', error);
                throw error;
            }
        }

        async function uploadMedia() {
            const user = JSON.parse(localStorage.getItem('user'));
            if (!user) {
                alert('Please log in to upload videos.');
                hideUploadForm();
                return;
            }

            const mediaInput = document.getElementById('mediaInput');
            const mediaTitle = document.getElementById('mediaTitle').value.trim();
            const uploadButton = document.getElementById('uploadButton');
            const uploadStatus = document.getElementById('uploadStatus');

            if (!mediaInput.files.length || !mediaTitle) {
                alert('Please select a video and enter a title.');
                return;
            }

            uploadButton.disabled = true;
            mediaInput.disabled = true;
            document.getElementById('mediaTitle').disabled = true;
            uploadStatus.innerHTML = '<span class="spinner"></span>Analyzing video...';

            const file = mediaInput.files[0];
            if (!file.type.startsWith('video/mp4')) {
                alert('Please select an MP4 video.');
                resetUploadForm();
                return;
            }

            let thumbnailUrl = '';
            try {
                uploadStatus.innerHTML = '<span class="spinner"></span>Generating thumbnail...';
                const thumbnailFile = await captureThumbnail(file);
                thumbnailUrl = await uploadThumbnailToStorage(thumbnailFile);
            } catch (error) {
                console.error('Thumbnail error:', error);
                uploadStatus.textContent = 'Failed to generate thumbnail. Proceeding without thumbnail.';
            }

            const videoElement = document.createElement('video');
            videoElement.preload = 'metadata';
            videoElement.src = URL.createObjectURL(file);

            videoElement.onloadedmetadata = async () => {
                const durationSec = Math.floor(videoElement.duration);
                const hoursDur = Math.floor(durationSec / 3600);
                const minutesDur = Math.floor((durationSec % 3600) / 60);
                const secondsDur = durationSec % 60;

                let durationStr;
                if (hoursDur > 0) {
                    durationStr = `${hoursDur}:${minutesDur.toString().padStart(2, '0')}:${secondsDur.toString().padStart(2, '0')}`;
                } else if (minutesDur > 0) {
                    durationStr = `${minutesDur}:${secondsDur.toString().padStart(2, '0')}`;
                } else {
                    durationStr = `${secondsDur}`;
                }

                uploadStatus.innerHTML = '<span class="spinner"></span>Uploading video...';
                const mediaId = Date.now().toString();
                const identifier = `lustalbum-${mediaId}`;
                const filename = `${mediaTitle.replace(/[^a-zA-Z0-9]/g, '-')}.mp4`;
                const uploadUrl = `https://s3.us.archive.org/${identifier}/${filename}`;
                const playbackUrl = `https://archive.org/download/${identifier}/${filename}`;

                try {
                    const fileData = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = () => resolve(reader.result);
                        reader.onerror = () => reject(new Error('Failed to read file'));
                        reader.readAsArrayBuffer(file);
                    });

                    const xhr = new XMLHttpRequest();
                    xhr.open('PUT', uploadUrl, true);
                    xhr.setRequestHeader('Authorization', 'LOW t1neWUa7J_nuqGiMv:sLBddyAy31lVj4pR');
                    xhr.setRequestHeader('x-archive-auto-make-bucket', '1');
                    xhr.setRequestHeader('x-archive-queue-derive', '0');
                    xhr.setRequestHeader('x-archive-meta-title', mediaTitle);
                    xhr.setRequestHeader('x-archive-meta-mediatype', 'movies');

                    xhr.upload.onprogress = (event) => {
                        if (event.lengthComputable) {
                            const percent = Math.round((event.loaded / event.total) * 100);
                            uploadStatus.innerHTML = `<span class="spinner"></span>Uploading ${filename}... ${percent}%`;
                        }
                    };

                    await new Promise((resolve, reject) => {
                        xhr.onload = () => {
                            if (xhr.status === 200 || xhr.status === 201) {
                                uploadStatus.textContent = 'Uploaded video successfully';
                                resolve();
                            } else {
                                reject(new Error(`Upload failed with status ${xhr.status}`));
                            }
                        };
                        xhr.onerror = () => reject(new Error('Network error during upload'));
                        xhr.send(fileData);
                    });

                    const documentData = {
                        title: mediaTitle,
                        identifier: identifier,
                        userEmail: user.email,
                        mediaType: 'video',
                        url: playbackUrl,
                        duration: durationStr,
                        thumbnailUrl: thumbnailUrl || ''
                    };
                    console.log("Creating document:", documentData);
                    await database.createDocument(DATABASE_ID, VIDEO_COLLECTION_ID, 'unique()', documentData);
                    uploadStatus.textContent = 'Upload complete!';
                } catch (error) {
                    console.error('Upload error:', error);
                    uploadStatus.textContent = `Failed to upload video.`;
                    alert(`Failed to upload video: ${error.message}`);
                    resetUploadForm();
                    return;
                }

                setTimeout(() => {
                    hideUploadForm();
                    displayMedia();
                }, 1000);
            };

            videoElement.onerror = () => {
                console.error("Failed to analyze video duration");
                alert('Failed to analyze video duration.');
                resetUploadForm();
            };

            videoElement.load();
        }

        function resetUploadForm() {
            console.log("Resetting upload form...");
            document.getElementById('uploadButton').disabled = false;
            document.getElementById('mediaInput').disabled = false;
            document.getElementById('mediaTitle').disabled = false;
        }

        // Simplified displayMedia function
        async function displayMedia() {
            console.log("Fetching videos...");
            const mediaGrid = document.getElementById('mediaGrid');
            const user = JSON.parse(localStorage.getItem('user'));
            mediaGrid.innerHTML = '';

            try {
                const response = await database.listDocuments(DATABASE_ID, VIDEO_COLLECTION_ID);
                const videos = response.documents;
                console.log("Videos fetched:", videos);

                if (videos.length === 0) {
                    mediaGrid.innerHTML = '<p class="text-gray-400 text-center">No videos available.</p>';
                    return;
                }

                const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
                const filteredVideos = searchTerm
                    ? videos.filter(video => video.title && video.title.toLowerCase().includes(searchTerm))
                    : videos;

                if (filteredVideos.length === 0) {
                    mediaGrid.innerHTML = '<p class="text-gray-400 text-center">No videos match your search.</p>';
                    return;
                }

                filteredVideos.forEach(item => {
                    const mediaCard = document.createElement('div');
                    mediaCard.className = 'video-card';
                    const createdAt = new Date(item.$createdAt);
                    const now = new Date();
                    const diffMs = now - createdAt;
                    const seconds = Math.floor(diffMs / 1000);
                    const minutes = Math.floor(seconds / 60);
                    const hours = Math.floor(minutes / 60);
                    const days = Math.floor(hours / 24);
                    let timeAgo;

                    if (seconds < 60) {
                        timeAgo = `${seconds} sec ago`;
                    } else if (minutes < 60) {
                        timeAgo = `${minutes} min ago`;
                    } else if (hours < 24) {
                        timeAgo = `${hours} hour${hours === 1 ? '' : 's'} ago`;
                    } else {
                        timeAgo = `${days} day${days === 1 ? '' : 's'} ago`;
                    }

                    const durationStr = item.duration || '0:00';
                    const thumbnailUrl = item.thumbnailUrl || 'https://via.placeholder.com/220x140?text=No+Thumbnail';
                    const isOwnVideo = user && item.userEmail === user.email;
                    const titleSectionClass = isOwnVideo ? 'title-section golden-border' : 'title-section';

                    mediaCard.innerHTML = `
                        <div class="thumbnail-container">
                            <img src="${thumbnailUrl}" alt="Thumbnail" onerror="this.src='https://via.placeholder.com/220x140?text=Thumbnail+Error'">
                            <div style="position: absolute; top: 0; right: 0; padding: 0.25rem 0.5rem; background: rgba(0, 0, 0, 0.7); color: #ffffff; font-size: 0.75rem;">${durationStr}</div>
                        </div>
                        <div class="${titleSectionClass}">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <h3 style="margin: 0; font-size: 0.95rem; font-weight: 500; color: #e5e7eb;">${item.title}</h3>
                                <div style="color: #9ca3af; font-size: 0.8rem;">${timeAgo}</div>
                            </div>
                        </div>
                    `;
                    mediaCard.onclick = () => openMediaPopup(item.$id, item.identifier, item.title);
                    mediaGrid.appendChild(mediaCard);
                });
            } catch (error) {
                console.error('Error fetching videos:', error);
                mediaGrid.innerHTML = '<p class="text-gray-400 text-center">Failed to load videos. Please try again.</p>';
            }
        }

        function openMediaPopup(id, identifier, title) {
            console.log("Opening media popup:", id, identifier, title);
            const popup = document.getElementById('mediaPopup');
            const video = document.getElementById('popupVideo');
            const videoLoading = document.getElementById('videoLoading');
            const videoError = document.getElementById('videoError');
            const popupTitle = document.getElementById('popupTitle');
            const playPauseBtn = document.getElementById('playPauseBtn');
            const progressBar = document.getElementById('progressBar');
            const progress = document.getElementById('progress');
            const timestamp = document.getElementById('timestamp');
            const playbackSpeedBtn = document.getElementById('playbackSpeedBtn');
            const playbackSpeedMenu = document.getElementById('playbackSpeedMenu');
            const volumeBtn = document.getElementById('volumeBtn');
            const volumeSlider = document.getElementById('volumeSlider');
            const fullscreenBtn = document.getElementById('fullscreenBtn');
            const videoControls = document.getElementById('videoControls');

            video.src = '';
            video.style.display = 'block';
            videoLoading.style.display = 'block';
            videoError.style.display = 'none';
            progress.style.width = '0%';
            timestamp.textContent = '0:00 / 0:00';
            playPauseBtn.innerHTML = 'â–¶';
            volumeBtn.innerHTML = 'ðŸ”Š';
            volumeSlider.value = 1;
            video.volume = 1;
            playbackSpeedBtn.textContent = '1x';
            playbackSpeedMenu.classList.remove('show');
            videoControls.classList.add('show');

            volumeSlider.style.setProperty('--value', volumeSlider.value);
            volumeSlider.addEventListener('input', () => {
                volumeSlider.style.setProperty('--value', volumeSlider.value);
            });

            const filename = `${title.replace(/[^a-zA-Z0-9]/g, '-')}.mp4`;
            const playbackUrl = `https://archive.org/download/${identifier}/${filename}`;
            console.log("Playback URL:", playbackUrl);

            if (!identifier || !title) {
                console.error('Invalid video data:', { identifier, title });
                videoLoading.style.display = 'none';
                videoError.style.display = 'block';
                videoError.textContent = 'Cannot load video: Invalid video data.';
                return;
            }

            video.src = playbackUrl;
            popupTitle.textContent = title;
            popup.style.display = 'block';
            document.getElementById('overlay').style.display = 'block';
            history.pushState({ popupOpen: 'media', id: id }, '', `#media-${id}`);

            let hideControlsTimeout;
            function setControlsTimeout() {
                if (document.fullscreenElement) {
                    clearTimeout(hideControlsTimeout);
                    videoControls.classList.add('show');
                    hideControlsTimeout = setTimeout(() => {
                        videoControls.classList.remove('show');
                    }, 3000);
                }
            }

            function showControlsOnInteraction() {
                if (document.fullscreenElement) {
                    videoControls.classList.add('show');
                    clearTimeout(hideControlsTimeout);
                    hideControlsTimeout = setTimeout(() => {
                        videoControls.classList.remove('show');
                    }, 3000);
                }
            }

            video.onloadedmetadata = () => {
                console.log("Video metadata loaded");
                videoLoading.style.display = 'none';
                timestamp.textContent = `0:00 / ${formatTime(video.duration)}`;
                video.play().catch(error => {
                    console.error("Error playing video:", error);
                    videoLoading.style.display = 'none';
                    videoError.style.display = 'block';
                    videoError.textContent = `Error playing video: ${error.message}.`;
                    video.style.display = 'none';
                });
            };

            video.onerror = () => {
                console.error("Video load error:", video.error?.message);
                videoLoading.style.display = 'none';
                videoError.style.display = 'block';
                videoError.textContent = 'Failed to load video. Check console for details.';
                video.style.display = 'none';
            };

            function formatTime(seconds) {
                const min = Math.floor(seconds / 60);
                const sec = Math.floor(seconds % 60);
                return `${min}:${sec.toString().padStart(2, '0')}`;
            }

            function updateProgress() {
                if (video.duration) {
                    const percent = (video.currentTime / video.duration) * 100;
                    progress.style.width = `${percent}%`;
                    timestamp.textContent = `${formatTime(video.currentTime)} / ${formatTime(video.duration)}`;
                }
            }

            function togglePlayPause() {
                if (video.paused) {
                    video.play().catch(error => {
                        console.error("Error playing video:", error);
                        videoError.style.display = 'block';
                        videoError.textContent = `Error playing video: ${error.message}.`;
                        video.style.display = 'none';
                    });
                    playPauseBtn.innerHTML = 'âšâš';
                } else {
                    video.pause();
                    playPauseBtn.innerHTML = 'â–¶';
                }
            }

            function updateVolumeIcon() {
                if (video.muted || video.volume === 0) {
                    volumeBtn.innerHTML = 'ðŸ”‡';
                } else if (video.volume < 0.5) {
                    volumeBtn.innerHTML = 'ðŸ”‰';
                } else {
                    volumeBtn.innerHTML = 'ðŸ”Š';
                }
            }

            video.addEventListener('timeupdate', updateProgress);
            video.addEventListener('play', () => {
                playPauseBtn.innerHTML = 'âšâš';
                videoLoading.style.display = 'none';
            });
            video.addEventListener('pause', () => {
                playPauseBtn.innerHTML = 'â–¶';
            });

            playPauseBtn.onclick = togglePlayPause;

            progressBar.onclick = (e) => {
                const rect = progressBar.getBoundingClientRect();
                const pos = (e.clientX - rect.left) / rect.width;
                video.currentTime = pos * video.duration;
            };

            playbackSpeedBtn.onclick = (e) => {
                e.stopPropagation();
                playbackSpeedMenu.classList.toggle('show');
            };

            playbackSpeedMenu.querySelectorAll('.playback-speed-option').forEach(option => {
                option.onclick = (e) => {
                    e.stopPropagation();
                    const speed = parseFloat(option.getAttribute('data-value'));
                    video.playbackRate = speed;
                    playbackSpeedBtn.textContent = option.textContent;
                    playbackSpeedMenu.classList.remove('show');
                };
            });

            document.addEventListener('click', (e) => {
                if (!playbackSpeedBtn.contains(e.target) && !playbackSpeedMenu.contains(e.target)) {
                    playbackSpeedMenu.classList.remove('show');
                }
            });

            volumeSlider.oninput = () => {
                video.volume = volumeSlider.value;
                video.muted = video.volume === 0;
                updateVolumeIcon();
                volumeSlider.style.setProperty('--value', volumeSlider.value);
            };

            volumeBtn.onclick = () => {
                video.muted = !video.muted;
                volumeSlider.value = video.muted ? 0 : video.volume;
                updateVolumeIcon();
                volumeSlider.style.setProperty('--value', volumeSlider.value);
            };

            fullscreenBtn.onclick = () => {
                if (!document.fullscreenElement) {
                    popup.requestFullscreen().catch(err => {
                        console.error('Fullscreen error:', err);
                    });
                } else {
                    document.exitFullscreen();
                }
            };

            document.addEventListener('fullscreenchange', () => {
                fullscreenBtn.innerHTML = document.fullscreenElement ? 'â­¯' : 'â›¶';
                if (document.fullscreenElement) {
                    setControlsTimeout();
                } else {
                    videoControls.classList.add('show');
                    clearTimeout(hideControlsTimeout);
                }
            });

            popup.addEventListener('mousemove', showControlsOnInteraction);
            popup.addEventListener('click', showControlsOnInteraction);
            popup.addEventListener('touchstart', showControlsOnInteraction);
        }

        function closeMediaPopup() {
            console.log("Closing media popup...");
            const popup = document.getElementById('mediaPopup');
            const video = document.getElementById('popupVideo');
            const videoLoading = document.getElementById('videoLoading');
            const videoError = document.getElementById('videoError');
            const videoControls = document.getElementById('videoControls');
            video.pause();
            video.src = '';
            video.onerror = null;
            videoLoading.style.display = 'block';
            videoError.style.display = 'none';
            video.style.display = 'block';
            popup.style.display = 'none';
            document.getElementById('overlay').style.display = 'none';
            history.replaceState(null, '', '/#home');
            if (document.fullscreenElement) {
                document.exitFullscreen();
            }
            videoControls.classList.add('show');
        }

        async function openProfilePopup() {
            const user = JSON.parse(localStorage.getItem('user'));
            if (!user) {
                alert('Please log in to view your profile.');
                return;
            }

            console.log("Opening profile popup...");
            const popup = document.getElementById('profilePopup');
            const profileInfo = document.getElementById('profileInfo');
            const profileVideos = document.getElementById('profileVideos');

            profileInfo.innerHTML = `
                <img src="${user.picture || 'defaultdp.png'}" alt="Profile Picture">
                <h2>${user.name}</h2>
                <p>${user.email}</p>
            `;

            profileVideos.innerHTML = '';

            try {
                const videoResponse = await database.listDocuments(DATABASE_ID, VIDEO_COLLECTION_ID, [
                    Appwrite.Query.equal('userEmail', user.email)
                ]);
                const videos = videoResponse.documents;

                if (videos.length === 0) {
                    profileVideos.innerHTML = '<p class="text-gray-400 text-center">No videos uploaded yet.</p>';
                } else {
                    videos.forEach(item => {
                        const mediaCard = document.createElement('div');
                        mediaCard.className = 'video-card';
                        const createdAt = new Date(item.$createdAt);
                        const now = new Date();
                        const diffMs = now - createdAt;
                        const seconds = Math.floor(diffMs / 1000);
                        const minutes = Math.floor(seconds / 60);
                        const hours = Math.floor(minutes / 60);
                        const days = Math.floor(hours / 24);
                        let timeAgo;

                        if (seconds < 60) {
                            timeAgo = `${seconds} sec ago`;
                        } else if (minutes < 60) {
                            timeAgo = `${minutes} min ago`;
                        } else if (hours < 24) {
                            timeAgo = `${hours} hour${hours === 1 ? '' : 's'} ago`;
                        } else {
                            timeAgo = `${days} day${days === 1 ? '' : 's'} ago`;
                        }

                        const durationStr = item.duration || '0:00';
                        const thumbnailUrl = item.thumbnailUrl || 'https://via.placeholder.com/220x140?text=No+Thumbnail';

                        mediaCard.innerHTML = `
                            <div class="thumbnail-container">
                                <img src="${thumbnailUrl}" alt="Thumbnail" onerror="this.src='https://via.placeholder.com/220x140?text=Thumbnail+Error'">
                                <div style="position: absolute; top: 0; right: 0; padding: 0.25rem 0.5rem; background: rgba(0, 0, 0, 0.7); color: #ffffff; font-size: 0.75rem;">${durationStr}</div>
                            </div>
                            <div class="title-section">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <h3 style="margin: 0; font-size: 0.95rem; font-weight: 500; color: #e5e7eb;">${item.title}</h3>
                                    <div style="color: #9ca3af; font-size: 0.8rem;">${timeAgo}</div>
                                </div>
                            </div>
                        `;
                        mediaCard.onclick = () => {
                            closeProfilePopup();
                            openMediaPopup(item.$id, item.identifier, item.title);
                        };
                        profileVideos.appendChild(mediaCard);
                    });
                }
            } catch (error) {
                console.error('Error loading profile videos:', error);
                profileVideos.innerHTML = '<p class="text-gray-400 text-center">Failed to load videos.</p>';
            }

            popup.style.display = 'block';
            document.getElementById('overlay').style.display = 'block';
            history.pushState({ popupOpen: 'profile' }, '', '#profile');
        }

        function closeProfilePopup() {
            console.log("Closing profile popup...");
            document.getElementById('profilePopup').style.display = 'none';
            document.getElementById('overlay').style.display = 'none';
            history.replaceState(null, '', '/#home');
        }

        async function handleInitialNavigation() {
            console.log("Handling initial navigation...");
            const hash = window.location.hash;
            if (hash.startsWith('#media-')) {
                const videoId = hash.replace('#media-', '');
                try {
                    const video = await database.getDocument(DATABASE_ID, VIDEO_COLLECTION_ID, videoId);
                    openMediaPopup(video.$id, video.identifier, video.title);
                } catch (error) {
                    console.error('Error loading video from URL:', error);
                    history.replaceState(null, '', '/#home');
                }
            } else if (hash === '#profile') {
                openProfilePopup();
            } else {
                history.replaceState(null, '', '/#home');
            }
        }

        window.onpopstate = function(event) {
            console.log("Handling popstate:", event.state);
            const state = event.state;
            if (state && state.popupOpen === 'media' && state.id) {
                database.getDocument(DATABASE_ID, VIDEO_COLLECTION_ID, state.id)
                    .then(video => {
                        openMediaPopup(video.$id, video.identifier, video.title);
                    })
                    .catch(error => {
                        console.error('Error reloading video:', error);
                        closeMediaPopup();
                    });
            } else if (state && state.popupOpen === 'profile') {
                openProfilePopup();
            } else {
                closeMediaPopup();
                closeProfilePopup();
            }
        };

        // Add search input handler
        document.getElementById('searchInput').oninput = function() {
            displayMedia();
        };

        window.onload = function() {
            console.log("Page loaded...");
            updateHeader();
            displayMedia();
            handleInitialNavigation();
        };
    </script>
</body>
</html>
